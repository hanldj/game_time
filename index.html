<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>複利時間銀行 (定時發薪版)</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --lionel-color: #3b82f6;
            --yosie-color: #8b5cf6;
            --yvonne-color: #ec4899;
            --toast-bg: rgba(0, 0, 0, 0.85);
        }

        body {
            font-family: "SF Mono", "Roboto Mono", "Courier New", monospace;
            background-color: var(--bg-color);
            margin: 0;
            padding: 16px;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 50px;
        }

        .header {
            text-align: center;
            margin-bottom: 5px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .header h1 {
            margin: 0;
            font-size: 1.4rem;
            color: #374151;
        }

        .header .subtitle {
            font-size: 0.8rem;
            color: #10b981;
            font-weight: bold;
            margin-top: 4px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 5px solid #ccc;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .card[data-id="p1"] { border-color: var(--lionel-color); }
        .card[data-id="p2"] { border-color: var(--yosie-color); }
        .card[data-id="p3"] { border-color: var(--yvonne-color); }

        input.name-input {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #4b5563;
            border: 1px solid transparent;
            background: transparent;
            text-align: center;
            width: 100%;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        input.name-input:focus {
            border-color: #ccc;
            background: #f9fafb;
            outline: none;
        }

        .time-wrapper {
            display: flex;
            align-items: baseline;
            justify-content: center;
            margin: 10px 0 20px 0;
            width: 100%;
        }

        input.time-input {
            font-family: "SF Mono", "Roboto Mono", "Courier New", monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            border: 1px solid transparent;
            background: transparent;
            text-align: center;
            width: 340px;
            max-width: 80%;
            border-radius: 8px;
            padding: 0 5px;
        }

        @media (max-width: 360px) {
            input.time-input { font-size: 2rem; }
        }

        input.time-input:focus {
            background: #fffbe6;
            border-color: #fbbf24;
            outline: none;
        }

        .unit {
            font-size: 1rem;
            color: #9ca3af;
            margin-left: 5px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            flex-shrink: 0;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
        }

        button {
            border: none;
            padding: 12px 0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            touch-action: manipulation;
        }

        button:active { transform: scale(0.96); opacity: 0.9; }

        .btn-plus-10 { background-color: #4338ca; }
        .btn-plus-5 { background-color: #3b82f6; }
        .btn-plus-1 { background-color: #10b981; }

        .btn-minus-1 { background-color: #f59e0b; }
        .btn-minus-5 { background-color: #ef4444; }
        .btn-minus-10 { background-color: #b91c1c; }

        .rate-info {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 10px;
            text-align: center;
            line-height: 1.4;
        }

        .editable-hint {
            font-size: 0.6rem;
            color: #d1d5db;
            margin-bottom: 2px;
        }

        #toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            width: 90%;
            align-items: center;
        }

        .toast {
            background-color: var(--toast-bg);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInOut 4s forwards;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>複利時間銀行</h1>
            <div class="subtitle">01:20 自動發薪 +15分 • 日利 0.5%</div>
        </div>

        <div class="card" data-id="p1">
            <div class="editable-hint">✎ 點擊改名</div>
            <input type="text" class="name-input" id="name-p1" onchange="updateName('p1', this.value)">

            <div class="time-wrapper">
                <input type="number" class="time-input" id="val-p1" step="0.00001"
                       onfocus="startEditing('p1')"
                       onblur="finishEditing('p1', this.value)"
                       onkeydown="if(event.key === 'Enter') this.blur()">
                <span class="unit">分</span>
            </div>

            <div class="btn-grid">
                <button class="btn-plus-10" onclick="transaction('p1', 10)">+10</button>
                <button class="btn-plus-5" onclick="transaction('p1', 5)">+5</button>
                <button class="btn-plus-1" onclick="transaction('p1', 1)">+1</button>
                <button class="btn-minus-10" onclick="transaction('p1', -10)">-10</button>
                <button class="btn-minus-5" onclick="transaction('p1', -5)">-5</button>
                <button class="btn-minus-1" onclick="transaction('p1', -1)">-1</button>
            </div>
            <div class="rate-info">每日 01:20 自動入帳 15 分鐘</div>
        </div>

        <div class="card" data-id="p2">
            <div class="editable-hint">✎ 點擊改名</div>
            <input type="text" class="name-input" id="name-p2" onchange="updateName('p2', this.value)">

            <div class="time-wrapper">
                <input type="number" class="time-input" id="val-p2" step="0.00001"
                       onfocus="startEditing('p2')"
                       onblur="finishEditing('p2', this.value)"
                       onkeydown="if(event.key === 'Enter') this.blur()">
                <span class="unit">分</span>
            </div>

            <div class="btn-grid">
                <button class="btn-plus-10" onclick="transaction('p2', 10)">+10</button>
                <button class="btn-plus-5" onclick="transaction('p2', 5)">+5</button>
                <button class="btn-plus-1" onclick="transaction('p2', 1)">+1</button>
                <button class="btn-minus-10" onclick="transaction('p2', -10)">-10</button>
                <button class="btn-minus-5" onclick="transaction('p2', -5)">-5</button>
                <button class="btn-minus-1" onclick="transaction('p2', -1)">-1</button>
            </div>
            <div class="rate-info">每日 01:20 自動入帳 15 分鐘</div>
        </div>

        <div class="card" data-id="p3">
            <div class="editable-hint">✎ 點擊改名</div>
            <input type="text" class="name-input" id="name-p3" onchange="updateName('p3', this.value)">

            <div class="time-wrapper">
                <input type="number" class="time-input" id="val-p3" step="0.00001"
                       onfocus="startEditing('p3')"
                       onblur="finishEditing('p3', this.value)"
                       onkeydown="if(event.key === 'Enter') this.blur()">
                <span class="unit">分</span>
            </div>

            <div class="btn-grid">
                <button class="btn-plus-10" onclick="transaction('p3', 10)">+10</button>
                <button class="btn-plus-5" onclick="transaction('p3', 5)">+5</button>
                <button class="btn-plus-1" onclick="transaction('p3', 1)">+1</button>
                <button class="btn-minus-10" onclick="transaction('p3', -10)">-10</button>
                <button class="btn-minus-5" onclick="transaction('p3', -5)">-5</button>
                <button class="btn-minus-1" onclick="transaction('p3', -1)">-1</button>
            </div>
            <div class="rate-info">每日 01:20 自動入帳 15 分鐘</div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- 設定區 ---
        const DAILY_RATE = 0.005; // 0.5% 日利率
        const SALARY_AMOUNT = 15; // 每日薪水 (分)
        const SALARY_HOUR = 1;    // 凌晨 1 點
        const SALARY_MINUTE = 20; // 20 分
        const MS_IN_DAY = 1000 * 60 * 60 * 24;

        // 預設資料
        // lastSalaryCheck: 上次檢查發薪的時間戳記 (預設為現在，避免第一次打開就發薪，除非你希望)
        const defaultData = {
            p1: { name: "Lionel", balance: 30, lastUpdate: Date.now(), lastSalaryCheck: Date.now() },
            p2: { name: "Yosie", balance: 70, lastUpdate: Date.now(), lastSalaryCheck: Date.now() },
            p3: { name: "Yvonne", balance: 50, lastUpdate: Date.now(), lastSalaryCheck: Date.now() }
        };

        // 讀取資料 (版本號 v4 以區隔舊資料)
        let appData = JSON.parse(localStorage.getItem('compoundTimeBank_v4')) || defaultData;

        // 資料遷移防呆
        ['p1', 'p2', 'p3'].forEach(pid => {
            if (!appData[pid].lastSalaryCheck) {
                appData[pid].lastSalaryCheck = Date.now();
            }
        });

        let editingState = { p1: false, p2: false, p3: false };

        function init() {
            initRender();
            checkSalary(); // 檢查發薪
            animate();

            // 每次切換回網頁都檢查一次
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === 'visible') {
                    checkSalary();
                }
            });
        }

        // --- 核心：薪水發放邏輯 ---
        function checkSalary() {
            const now = Date.now();
            let anyUpdate = false;

            ['p1', 'p2', 'p3'].forEach(pid => {
                const data = appData[pid];

                // 1. 找出「上一次檢查點」之後的「下一個 01:20 AM」
                // 我們使用迴圈來補足這段時間內所有錯過的薪水
                let checkCursor = new Date(data.lastSalaryCheck);

                // 產生一個「理論上的下一次領薪時間」
                // 先設為檢查點當天的 01:20
                let nextPayTime = new Date(checkCursor);
                nextPayTime.setHours(SALARY_HOUR, SALARY_MINUTE, 0, 0);

                // 如果這個時間點已經在檢查點之前，代表當天的已經領過了，目標是明天
                if (nextPayTime.getTime() <= checkCursor.getTime()) {
                    nextPayTime.setDate(nextPayTime.getDate() + 1);
                }

                let salaryCount = 0;

                // 2. 迴圈檢查：只要「下一次領薪時間」早於「現在」，就發薪
                while (nextPayTime.getTime() <= now) {
                    salaryCount++;
                    // 往後推一天
                    nextPayTime.setDate(nextPayTime.getDate() + 1);
                }

                // 3. 如果有累積薪水要發
                if (salaryCount > 0) {
                    // 先結算利息更新到現在
                    const timeDiff = now - data.lastUpdate;
                    const daysPassed = timeDiff / MS_IN_DAY;
                    let currentBalance = data.balance * Math.pow((1 + DAILY_RATE), daysPassed);

                    // 發薪水
                    const totalSalary = salaryCount * SALARY_AMOUNT;
                    currentBalance += totalSalary;

                    // 記錄與通知
                    data.balance = currentBalance;
                    data.lastUpdate = now;
                    data.lastSalaryCheck = now; // 更新檢查點到現在

                    showToast(`${data.name}: 發放薪資 ${salaryCount} 次 (共 +${totalSalary} 分)`);
                    anyUpdate = true;
                }
            });

            if (anyUpdate) {
                saveData();
            }
        }

        function initRender() {
            document.getElementById('name-p1').value = appData.p1.name;
            document.getElementById('name-p2').value = appData.p2.name;
            document.getElementById('name-p3').value = appData.p3.name;
        }

        function animate() {
            const now = Date.now();

            ['p1', 'p2', 'p3'].forEach(pid => {
                if (editingState[pid]) return;

                const data = appData[pid];
                const timeDiff = now - data.lastUpdate;
                const daysPassed = timeDiff / MS_IN_DAY;
                const currentAmount = data.balance * Math.pow((1 + DAILY_RATE), daysPassed);

                const el = document.getElementById(`val-${pid}`);
                if (el) el.value = currentAmount.toFixed(5);
            });

            requestAnimationFrame(animate);
        }

        function updateName(pid, newName) {
            appData[pid].name = newName;
            saveData();
        }

        function startEditing(pid) {
            editingState[pid] = true;
        }

        function finishEditing(pid, newValStr) {
            let newVal = parseFloat(newValStr);
            if (isNaN(newVal)) newVal = 0;
            if (newVal < 0) newVal = 0;

            const now = Date.now();
            appData[pid].balance = newVal;
            appData[pid].lastUpdate = now;
            // 手動修改不影響發薪檢查點 (lastSalaryCheck)

            saveData();
            editingState[pid] = false;
        }

        function transaction(pid, amount) {
            const now = Date.now();
            const data = appData[pid];

            const timeDiff = now - data.lastUpdate;
            const daysPassed = timeDiff / MS_IN_DAY;
            let currentRealBalance = data.balance * Math.pow((1 + DAILY_RATE), daysPassed);

            currentRealBalance += amount;
            if (currentRealBalance < 0) currentRealBalance = 0;

            data.balance = currentRealBalance;
            data.lastUpdate = now;
            saveData();

            const el = document.getElementById(`val-${pid}`);
            el.value = currentRealBalance.toFixed(5);
        }

        function saveData() {
            localStorage.setItem('compoundTimeBank_v4', JSON.stringify(appData));
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        init();

    </script>
</body>
</html>
