<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›»ç©æ™‚é–“ç®¡ç†</title>
    <style>
        :root {
            --primary: #007AFF; /* iOS Blue */
            --danger: #FF3B30;  /* iOS Red */
            --bg: #F2F2F7;      /* iOS Grouped BG */
            --card: #FFFFFF;
            --text: #000000;
            --subtext: #8E8E93;
            --border: #C6C6C8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }

        /* Calendar Header */
        header {
            background-color: var(--card);
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .controls { display: flex; justify-content: space-between; margin-top: 10px; align-items: center; }
        .btn-text { background: none; border: none; color: var(--primary); font-size: 16px; cursor: pointer; }

        /* Calendar Grid */
        .calendar {
            background: var(--card);
            padding-bottom: 10px;
        }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--subtext); padding: 5px 0; }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
            cursor: pointer;
            border-radius: 50%;
            margin: 2px;
        }
        .day.today { color: var(--primary); font-weight: bold; }
        .day.selected { background-color: var(--text); color: white; border-radius: 50%; }
        .day.has-data::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background-color: var(--subtext);
            border-radius: 50%;
        }

        /* Detail View (Bottom Sheet style) */
        .detail-view {
            padding: 20px 15px;
            background-color: var(--bg);
            min-height: calc(100vh - 350px);
        }
        .date-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; padding-left: 5px; }

        /* Child Card */
        .kid-card {
            background-color: var(--card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .kid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .kid-name { font-size: 18px; font-weight: 600; border: none; background: transparent; width: 60%; }
        .kid-name:focus { border-bottom: 1px solid var(--primary); outline: none; }

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .stat-label { color: var(--subtext); }
        .stat-val { font-weight: 500; font-family: monospace; font-size: 15px; }
        .stat-val.editable { border-bottom: 1px dashed var(--border); color: var(--primary); cursor: pointer; }

        .action-area {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-time {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        .btn-action {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-action:disabled { background-color: var(--subtext); }

        .history-text { font-size: 14px; color: var(--subtext); margin-top: 10px; text-align: center; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 25px;
            padding: 16px;
            position: fixed;
            z-index: 101;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
        }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<header>
    <h1>é›»ç©æ™‚å…‰å­˜æ‘º</h1>
    <div class="controls">
        <button class="btn-text" onclick="changeMonth(-1)">â®</button>
        <span id="currentMonthYear" style="font-weight:600; font-size: 16px;"></span>
        <button class="btn-text" onclick="changeMonth(1)">â¯</button>
    </div>
</header>

<div class="calendar">
    <div class="weekdays">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
    <div class="days" id="calendarDays"></div>
</div>

<div class="detail-view">
    <div class="date-title" id="selectedDateTitle">è«‹é¸æ“‡æ—¥æœŸ</div>
    <div id="kidsContainer"></div>
</div>

<div id="toast"></div>

<script>
    // --- Data Management ---
    const STORAGE_KEY = 'gameTimeData_v1';

    // åˆå§‹åŒ–æ•¸æ“š (é è¨­ç‚ºæ‚¨çš„ä¸‰ä½å°æœ‹å‹)
    let appData = {
        kids: [
            { id: 0, name: "Lionel", bank: 0 },
            { id: 1, name: "Yosie", bank: 0 },
            { id: 2, name: "Yvonne", bank: 0 }
        ],
        logs: {} // Format: "YYYY-MM-DD": { kidId: minutesPlayed }
    };

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            appData = JSON.parse(saved);
        } else {
            saveData();
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    // --- Date Helpers ---
    let currentDate = new Date();
    let selectedDate = new Date();

    function getFormattedDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function isToday(date) {
        const today = new Date();
        return date.getDate() === today.getDate() &&
               date.getMonth() === today.getMonth() &&
               date.getFullYear() === today.getFullYear();
    }

    // --- Calendar UI ---
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('currentMonthYear').innerText = `${year}å¹´ ${month + 1}æœˆ`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysContainer = document.getElementById('calendarDays');
        daysContainer.innerHTML = '';

        // Empty slots for previous month
        for (let i = 0; i < firstDay.getDay(); i++) {
            daysContainer.appendChild(document.createElement('div'));
        }

        // Days
        for (let i = 1; i <= lastDay.getDate(); i++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('day');
            dayEl.innerText = i;

            const renderDate = new Date(year, month, i);
            const dateStr = getFormattedDate(renderDate);

            if (isToday(renderDate)) dayEl.classList.add('today');
            if (dateStr === getFormattedDate(selectedDate)) dayEl.classList.add('selected');
            if (appData.logs[dateStr]) dayEl.classList.add('has-data');

            dayEl.onclick = () => {
                selectedDate = renderDate;
                renderCalendar(); // Re-render to update selection
                renderDetails();
            };

            daysContainer.appendChild(dayEl);
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // --- Core Logic & Detail UI ---

    // è¨ˆç®—é‚è¼¯ï¼šæ ¹æ“šéŠç©æ™‚é–“æ›´æ–°å„²è“„
    // è¦å‰‡ï¼š
    // 1. åŸºæœ¬ï¼š+15åˆ†/å¤© (ä¸ç©å°±æ˜¯å­˜15)
    // 2. ä½¿ç”¨ï¼šå…ˆæ‰£ç•¶æ—¥15ï¼Œå†æ‰£å­˜æ¬¾
    // 3. ä¸Šé™ï¼šç•¶æ—¥éŠç©ä¸Šé™ 30 (15åŸ+15å­˜)
    // 4. æ‡²ç½°ï¼šè¶…é30ï¼Œè¶…æ™‚éƒ¨åˆ†å…©å€æ‰£é™¤
    // å…¬å¼æ¨å°ï¼š
    // Delta (å­˜æ¬¾è®ŠåŒ–) = 15 - éŠç©æ™‚é–“
    // If éŠç©æ™‚é–“ > 30: Penalty = (éŠç©æ™‚é–“ - 30).
    // Total Change = Delta - Penalty.
    // ä¾‹ 33åˆ†: Delta = 15-33 = -18. Penalty = 3. Total = -21. (æ­£ç¢ºï¼šæ‰£åŸ15 + æ‰£å­˜15 + æ‰£ç½°3 + æ‰£ç½°3 = å­˜-21)
    // ä¾‹ 10åˆ†: Delta = 15-10 = +5. Penalty = 0. Total = +5.
    function calculateBankChange(playedMinutes) {
        let delta = 15 - playedMinutes;
        if (playedMinutes > 30) {
            delta -= (playedMinutes - 30); // é¡å¤–æ‰£é™¤ä¸€æ¬¡è¶…æ™‚éƒ¨åˆ†
        }
        return delta;
    }

    function renderDetails() {
        const dateStr = getFormattedDate(selectedDate);
        const isFuture = selectedDate > new Date() && !isToday(selectedDate);
        const container = document.getElementById('kidsContainer');

        // Update Title
        const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
        document.getElementById('selectedDateTitle').innerText =
            `${selectedDate.getMonth() + 1}/${selectedDate.getDate()} ${dayNames[selectedDate.getDay()]}`;

        container.innerHTML = '';

        appData.kids.forEach(kid => {
            const kidLog = appData.logs[dateStr] ? appData.logs[dateStr][kid.id] : null;
            const hasPlayed = kidLog !== undefined && kidLog !== null;

            // è¨ˆç®—ä»Šæ—¥å‰©é¤˜å¯ç©æ™‚é–“ (Max 30, but limited by Bank)
            // å¯ç© = 15 (ä»Šæ—¥) + Math.min(15, Bank)
            // å¦‚æœ Bank < 0, å‰‡å¯èƒ½å½±éŸ¿ä»Šæ—¥é¡åº¦? å‡è¨­ Bank < 0 å‰‡ç„¡æ³•æé ˜ï¼Œåªèƒ½ç©ä»Šæ—¥çš„ 15 ç”šè‡³æ›´å°‘?
            // ç°¡åŒ–è¦å‰‡ï¼šå¦‚æœ Bank < 0ï¼Œé‚„æ˜¯çµ¦ä»Šæ—¥ 15ï¼Œä½†é‚„å‚µå„ªå…ˆ?
            // ä¾ç…§éœ€æ±‚ï¼š "å¦‚æœå„²è“„æ™‚é–“è¶³å¤ ...æå–æœ€å¤š15åˆ†é˜"ã€‚
            // é¡¯ç¤ºé‚è¼¯ï¼š
            let maxFromBank = Math.max(0, Math.min(15, kid.bank));
            let todayPlayable = 15 + maxFromBank;
            // å¦‚æœä»Šå¤©å·²ç¶“ç©éäº†ï¼Œé¡¯ç¤ºä»–ç©äº†å¤šä¹…

            const card = document.createElement('div');
            card.className = 'kid-card';

            let html = `
                <div class="kid-header">
                    <input type="text" class="kid-name" value="${kid.name}" onchange="updateName(${kid.id}, this.value)">
                    <span style="font-size:24px;">ğŸ®</span>
                </div>

                <div class="stat-row">
                    <span class="stat-label">ç›®å‰ç¸½å„²è“„:</span>
                    <span class="stat-val editable" onclick="manualEditBank(${kid.id})">${kid.bank} åˆ†é˜</span>
                </div>
            `;

            if (isFuture) {
                html += `<div class="history-text">æœªä¾†æ—¥æœŸä¸å¯æ“ä½œ</div>`;
            } else if (hasPlayed) {
                // å·²ç¶“æœ‰ç´€éŒ„
                html += `
                    <div class="stat-row">
                        <span class="stat-label">ç•¶æ—¥ç´€éŒ„:</span>
                        <span class="stat-val" style="color:var(--primary)">å·²éŠç© ${kidLog} åˆ†é˜</span>
                    </div>
                    <div class="history-text">æœ¬æ—¥å·²çµç®— (è‹¥éœ€ä¿®æ”¹è«‹æ‰‹å‹•èª¿æ•´å„²è“„)</div>
                `;
            } else {
                // å°šæœªç´€éŒ„ (é€šå¸¸æ˜¯ä»Šå¤©)
                html += `
                    <div class="stat-row">
                        <span class="stat-label">ä»Šæ—¥ä¸Šé™:</span>
                        <span class="stat-val">${todayPlayable} åˆ†é˜ (15 + ${maxFromBank})</span>
                    </div>
                    <div class="action-area">
                        <input type="number" id="input-${kid.id}" class="input-time" placeholder="è¼¸å…¥ä»Šæ—¥éŠç©åˆ†é˜" inputmode="numeric">
                        <button class="btn-action" onclick="submitPlayTime(${kid.id})">ç¢ºèªæ‰£é™¤</button>
                    </div>
                    <div style="font-size:12px; color:#888; margin-top:5px;">*è¼¸å…¥ 0 å‰‡å­˜ä¸‹ä»Šæ—¥æ™‚é–“</div>
                `;
            }

            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    // --- Actions ---

    function updateName(id, newName) {
        const kid = appData.kids.find(k => k.id === id);
        if (kid) {
            kid.name = newName;
            saveData();
            showToast("åå­—å·²æ›´æ–°");
        }
    }

    function manualEditBank(id) {
        const kid = appData.kids.find(k => k.id === id);
        const newVal = prompt(`ä¿®æ”¹ ${kid.name} çš„å„²è“„æ™‚é–“ (ç›®å‰ ${kid.bank} åˆ†é˜):`, kid.bank);
        if (newVal !== null && !isNaN(newVal)) {
            kid.bank = parseInt(newVal);
            saveData();
            renderDetails();
            showToast("å„²è“„æ™‚é–“å·²æ‰‹å‹•æ›´æ–°");
        }
    }

    function submitPlayTime(id) {
        const input = document.getElementById(`input-${id}`);
        const val = input.value;

        if (val === "") {
            alert("è«‹è¼¸å…¥æ™‚é–“");
            return;
        }

        const minutesPlayed = parseInt(val);
        if (minutesPlayed < 0) {
            alert("æ™‚é–“ä¸èƒ½ç‚ºè² æ•¸");
            return;
        }

        // åŸ·è¡Œé‚è¼¯
        const kid = appData.kids.find(k => k.id === id);
        const change = calculateBankChange(minutesPlayed);

        // æ›´æ–°æ•¸æ“š
        kid.bank += change;

        // ç´€éŒ„ Log
        const dateStr = getFormattedDate(selectedDate);
        if (!appData.logs[dateStr]) appData.logs[dateStr] = {};
        appData.logs[dateStr][id] = minutesPlayed;

        saveData();
        renderCalendar(); // Update dots
        renderDetails();  // Update view

        let msg = "";
        if (change > 0) msg = `å­˜å…¥ ${change} åˆ†é˜ï¼`;
        else msg = `æ‰£é™¤ ${Math.abs(change)} åˆ†é˜ (å«æ‡²ç½°/æ¶ˆè€—)`;
        showToast(`${kid.name}: ${msg}`);
    }

    function showToast(text) {
        const x = document.getElementById("toast");
        x.innerText = text;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // Start
    loadData();
    renderCalendar();
    renderDetails();

</script>

</body>
</html>